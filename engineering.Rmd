---
title: "Pesquisa Engenharia"
subtitle: "Marketing Analytics"
author: "Viviane Sanchez"
institution: "Insper - PADS"
date: "10/23/2020"
output: html_document
---
# Introdução

## Objetivo

Avaliar o posicionamento da Faculdade de Engenharia do Insper a partir da pesquisa realizada.

Avalie o posicionamento da Faculdade de Engenharia do Insper, incluindo:
1. Elementos centrais da proposta de valor que são reconhecidos pelos consumidores.
2. Quais são os concorrentes.
3. Como os concorrentes são percebidos (segundo os atributos).
4. Quais os territórios de cada faculdade.

```{r setup, include=FALSE}

library(tidyverse)
library(tidymodels)
library(tidytext)
library(skimr)
library(ggrepel)
library(factoextra)
library(zoo)
library(clue)
library(readxl)
library(janitor)
library(lubridate)
library(inspectdf)
library(knitr)

```

# Dados

```{r}

types <- tibble(col_num = c(1:11),
               type = "guess") %>% 
  bind_rows(tibble(col_num = c(12:102),
                   type = "text")) %>% pull(type)

insper_raw <- read_excel("data/Insper.xlsx", col_types = types)

```

## Wrangling

  A seguir, dos nomes das colunas são extraídas as escolas e o tema de cada pergunta, assim como suas respostas. Combinando a função `pivot_longer` com expressões regulares (regex) o processo é aplicado de forma que a tabela de saída esteja no formato tidy. Como existem 3 pessoas na base que não deram resposta para nenhuma pergunta, essas linhas serão desconsideradas na análise.

```{r pressure, echo=FALSE}



de_para_escola <- tibble(melhor = c(1:8),
                  melhor_escola = c("fei","poli","maua","insper",
                              "usp_sc","mackenzie","ita","outra"))


de_para_curso <- tibble(curso = c(1:3),
                  nome_curso = c("a","b","c"))

escolas <- de_para %>% pull(melhor_escola)

insper <- insper_raw %>%
  filter(Finished != "0") %>% 
  select(-Finished) %>% 
  pivot_longer(cols = -c(1:11),
               names_to = c("pergunta", "escola"),
               names_pattern = '(\\w+|\\w+\\W|\\w+\\stecnico)(-\\w+)',
               values_to = "resposta") %>%
  clean_names() %>%
  rename_with(., ~ str_extract(.,"_[a-zA-Z]+\\z"), starts_with("x")) %>% 
  rename_with(., ~ str_remove(.,"_"), starts_with("_")) %>% 
  rename(outra_qual = qual,
         ref = cabeca) %>% #glimpse()
  left_join(de_para_escola, by = "melhor") %>% 
  left_join(de_para_curso, by = "curso") %>% 
  mutate(melhor_escola = if_else(is.na(melhor_escola), "outra", melhor_escola),
         across(where(is.character), str_to_lower),
         idade = as.numeric(str_extract(idade, "\\d+")),
         resposta = if_else(resposta == "x", "0", resposta),
         resposta = if_else(is.na(resposta), 0, as.numeric(resposta)),
         pergunta = case_when(str_detect(pergunta, '_rio') ~ "infra",
                              str_detect(pergunta, 'rio') ~ "custo",
                              str_detect(pergunta, 'graduar') ~ "reconhecimento",
                              str_detect(pergunta, 'academico') ~ "rigor",
                              str_detect(pergunta, 'conhecimento') ~ "tecnica",
                              str_detect(pergunta, 'do tecnico') ~  "multidisciplinar",
                              TRUE ~ str_remove(pergunta, "\\W")),
         escola = str_remove(escola,"-"),
         escola = case_when(escola == "sao" ~ "usp_sc",
                            is.na(escola) ~ "outra",
                            TRUE ~ escola), 
        ref = case_when(str_detect(ref, 'poli|usp') ~ "poli",
                        str_detect(ref, 'outra') ~ outra_qual,
                        is.na(ref) ~ "outra",
                        str_detect(ref, 'insper') ~ "insper",
                        TRUE ~ ref)) %>% glimpse


insper %>% skim()

```


```{r}


insper %>% select(resposta) %>% distinct()
  
insper_prep <- insper %>% 
  select(escola, pergunta, resposta) %>% 
    group_by(escola, pergunta) %>% 
    summarise(resposta = mean(resposta, na.rm = T))

skim(insper_prep)
  
insper_wide <- insper_prep  %>% 
  pivot_wider(names_from = pergunta,
              values_from = resposta) %>% 
  mutate(tradicional = if_else(is.na(tradicional), 0, tradicional)) %>% 
  ungroup()

insper_wide %>% 
  kable()

```


## PCA

```{r}

rec_pca <- recipe(~ ., insper_wide) %>% 
  step_normalize(all_numeric()) %>% 
  step_pca(all_numeric()) %>% 
  prep()

pca <- juice(rec_pca)


tidy_pca <- tidy(rec_pca, 2)

fviz_pca_biplot(tidy_pca)

tidy_pca %>%
  filter(component %in% paste0("PC", 1:6)) %>%
  group_by(component) %>%
  top_n(15, abs(value)) %>%
  ungroup() %>%
  mutate(terms = reorder_within(terms, abs(value), component)) %>%
  ggplot(aes(abs(value), terms, fill = if_else(value > 0, 'Positiva','Negativa'))) +
  geom_col(size = 0.5) +
  facet_wrap(~component, scales = "free_y") +
  scale_y_reordered() +
  scale_fill_manual(values = c('#4E84C4', '#2d2017')) +
  labs(x = "Valor absoluto da contribuição",
       y = NULL, fill = "Contribuição")

```


```{r}

pc_cr <- insper_wide %>% 
  select(-escola) %>% 
  prcomp(cor = TRUE)


pc_cr$x


fviz_pca_biplot(pc_cr, repel = TRUE)

```


